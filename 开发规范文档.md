# 星图项目 - 二次开发规范文档

## 项目架构概述

### 技术栈
- **后端**: FastAPI + SQLModel + PostgreSQL + Alembic
- **前端**: React 18 + TypeScript + TanStack Router + Chakra UI + TanStack Query
- **部署**: Docker + Docker Compose + Traefik
- **开发工具**: UV, Ruff, MyPy, Biome, Playwright

### 项目结构
```
xingtu/
├── backend/           # 后端API服务
├── frontend/          # 前端Web应用
├── scripts/           # 部署和构建脚本
├── docker-compose.yml # 容器编排配置
└── .env              # 环境变量配置
```

## 后端开发规范

### 1. 目录结构规范
```
backend/
├── app/
│   ├── api/                 # API路由层
│   │   ├── deps.py         # 依赖注入
│   │   ├── main.py         # 路由聚合
│   │   └── routes/         # 具体路由实现
│   ├── core/               # 核心配置
│   │   ├── config.py       # 应用配置
│   │   ├── db.py          # 数据库连接
│   │   └── security.py     # 安全相关
│   ├── alembic/           # 数据库迁移
│   ├── models.py          # 数据模型
│   ├── crud.py            # 数据库操作
│   └── utils.py           # 工具函数
├── tests/                 # 测试代码
└── scripts/               # 脚本文件
```

### 2. 代码风格规范

#### 2.1 Python代码规范
- **代码格式**: 使用 Ruff 进行代码格式化和检查
- **类型检查**: 使用 MyPy 进行严格类型检查
- **导入顺序**: 标准库 → 第三方库 → 本地模块

```python
# 正确的导入示例
import uuid
from typing import Any

from fastapi import APIRouter, Depends, HTTPException
from sqlmodel import select

from app.models import User, UserCreate
from app.core.config import settings
```

#### 2.2 命名规范
- **文件名**: 小写字母 + 下划线 (`user_routes.py`)
- **类名**: 大驼峰 (`UserCreate`, `ItemPublic`)
- **函数名**: 小写字母 + 下划线 (`create_user`, `get_current_user`)
- **常量**: 大写字母 + 下划线 (`ACCESS_TOKEN_EXPIRE_MINUTES`)

### 3. 数据模型规范

#### 3.1 SQLModel 模型定义
```python
# 基础模型
class UserBase(SQLModel):
    email: EmailStr = Field(unique=True, index=True, max_length=255)
    is_active: bool = True
    full_name: str | None = Field(default=None, max_length=255)

# 创建模型
class UserCreate(UserBase):
    password: str = Field(min_length=8, max_length=40)

# 数据库模型
class User(UserBase, table=True):
    id: uuid.UUID = Field(default_factory=uuid.uuid4, primary_key=True)
    hashed_password: str
    items: list["Item"] = Relationship(back_populates="owner", cascade_delete=True)

# 响应模型
class UserPublic(UserBase):
    id: uuid.UUID
```

#### 3.2 模型设计原则
- 每个实体至少包含：Base、Create、Update、Public 四种模型
- 使用 UUID 作为主键
- 字段必须指定最大长度限制
- 敏感字段不在 Public 模型中暴露
- 使用 Relationship 定义模型关联关系

### 4. API 路由规范

#### 4.1 路由组织
```python
# routes/users.py
router = APIRouter(prefix="/users", tags=["users"])

@router.get("/", response_model=UsersPublic)
def read_users(session: SessionDep, skip: int = 0, limit: int = 100):
    """获取用户列表"""
    pass

@router.post("/", response_model=UserPublic)
def create_user(*, session: SessionDep, user_in: UserCreate):
    """创建用户"""
    pass
```

#### 4.2 路由设计原则
- RESTful API 设计
- 使用依赖注入获取数据库会话和当前用户
- 明确指定 `response_model`
- 提供详细的文档字符串
- 错误处理使用 HTTPException

#### 4.3 权限控制
```python
# 需要超级用户权限
@router.get("/", dependencies=[Depends(get_current_active_superuser)])

# 需要登录用户
@router.get("/me")
def read_user_me(current_user: CurrentUser):
    pass
```

### 5. 数据库操作规范

#### 5.1 CRUD 操作
```python
# crud.py 中的标准操作
def get_user_by_email(*, session: Session, email: str) -> User | None:
    statement = select(User).where(User.email == email)
    return session.exec(statement).first()

def create_user(*, session: Session, user_create: UserCreate) -> User:
    db_obj = User.model_validate(
        user_create, update={"hashed_password": get_password_hash(user_create.password)}
    )
    session.add(db_obj)
    session.commit()
    session.refresh(db_obj)
    return db_obj
```

#### 5.2 数据库迁移规范
- 使用 Alembic 管理数据库迁移
- 迁移文件命名格式：`版本号_描述.py`
- 每次模型变更都必须创建迁移文件
- 生产环境迁移前必须备份数据库

```bash
# 创建迁移文件
alembic revision --autogenerate -m "add user table"

# 应用迁移
alembic upgrade head
```

### 6. 测试规范

#### 6.1 测试组织结构
```
tests/
├── api/                # API测试
├── crud/               # CRUD测试
├── conftest.py         # 测试配置
└── utils/              # 测试工具
```

#### 6.2 测试编写规范
```python
def test_create_user(client: TestClient, superuser_token_headers: dict[str, str]):
    data = {"email": "test@example.com", "password": "changethis"}
    r = client.post(f"{settings.API_V1_STR}/users/", 
                   headers=superuser_token_headers, 
                   json=data)
    assert r.status_code == 200
    created_user = r.json()
    assert created_user["email"] == data["email"]
```

## 前端开发规范

### 1. 目录结构规范
```
frontend/src/
├── components/         # 组件库
│   ├── Common/        # 通用组件
│   ├── ui/           # UI基础组件
│   └── [Feature]/    # 功能特定组件
├── hooks/            # 自定义Hooks
├── routes/           # 路由组件
├── client/           # API客户端
├── theme/            # 主题配置
└── utils.ts          # 工具函数
```

### 2. 组件开发规范

#### 2.1 组件命名和组织
```typescript
// components/Users/UserList.tsx
interface UserListProps {
  users: UserPublic[]
  onUserSelect: (user: UserPublic) => void
}

export const UserList: React.FC<UserListProps> = ({ users, onUserSelect }) => {
  return (
    <VStack spacing={4}>
      {users.map(user => (
        <UserCard key={user.id} user={user} onClick={() => onUserSelect(user)} />
      ))}
    </VStack>
  )
}
```

#### 2.2 组件设计原则
- 使用 TypeScript 进行类型定义
- Props 接口命名：`组件名 + Props`
- 导出为命名导出，不使用默认导出
- 使用 Chakra UI 组件库
- 组件文件名使用大驼峰命名

### 3. 状态管理规范

#### 3.1 使用 TanStack Query
```typescript
// hooks/useUsers.ts
export const useUsers = (params?: { skip?: number; limit?: number }) => {
  return useQuery({
    queryKey: ['users', params],
    queryFn: () => UsersService.readUsers(params),
    staleTime: 5 * 60 * 1000, // 5分钟
  })
}

export const useCreateUser = () => {
  const queryClient = useQueryClient()
  
  return useMutation({
    mutationFn: (data: UserCreate) => UsersService.createUser({ requestBody: data }),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['users'] })
    },
  })
}
```

#### 3.2 状态管理原则
- 服务器状态使用 TanStack Query
- 本地状态使用 useState/useReducer
- 全局状态尽量避免，使用 Context 或 Query 缓存
- 查询键使用数组形式，便于失效管理

### 4. 路由规范

#### 4.1 路由定义
```typescript
// routes/_layout/users.tsx
export const Route = createFileRoute('/_layout/users')({
  component: UsersPage,
  loader: ({ context }) => {
    // 预加载数据
    return context.queryClient.ensureQueryData({
      queryKey: ['users'],
      queryFn: () => UsersService.readUsers(),
    })
  },
})
```

#### 4.2 路由保护
```typescript
// 需要认证的路由
export const Route = createFileRoute('/_layout')({
  beforeLoad: ({ context, location }) => {
    if (!context.auth.isAuthenticated) {
      throw redirect({
        to: '/login',
        search: { redirect: location.href },
      })
    }
  },
})
```

### 5. API 客户端规范

#### 5.1 自动生成客户端
```bash
# 生成API客户端
npm run generate-client
```

#### 5.2 API 调用规范
```typescript
// 使用生成的客户端
import { UsersService, type UserCreate } from '@/client'

// 设置认证
OpenAPI.TOKEN = async () => {
  return localStorage.getItem('access_token') || ''
}

// 统一错误处理
const handleApiError = (error: Error) => {
  if (error instanceof ApiError && [401, 403].includes(error.status)) {
    localStorage.removeItem('access_token')
    window.location.href = '/login'
  }
}
```

### 6. 样式规范

#### 6.1 使用 Chakra UI
```typescript
// 推荐的样式写法
<Box
  p={4}
  borderRadius="md"
  boxShadow="sm"
  bg="white"
  _dark={{ bg: "gray.800" }}
>
  <Text fontSize="lg" fontWeight="bold">
    {title}
  </Text>
</Box>
```

#### 6.2 主题定制
```typescript
// theme/button.recipe.ts
export const buttonRecipe = defineRecipe({
  base: {
    fontWeight: 'semibold',
    borderRadius: 'md',
  },
  variants: {
    variant: {
      primary: { bg: 'blue.500', color: 'white' },
      secondary: { bg: 'gray.200', color: 'gray.800' },
    },
  },
})
```

## 开发流程规范

### 1. 环境搭建
```bash
# 克隆项目
git clone <repository-url>
cd xingtu

# 配置环境变量
cp .env.example .env

# 启动开发环境
docker-compose up -d

# 安装前端依赖
cd frontend && npm install

# 启动前端开发服务器
npm run dev
```

### 2. 代码提交规范

#### 2.1 Git 工作流
- 使用 feature 分支开发
- 提交前运行代码检查和测试
- 使用语义化提交信息

```bash
# 创建功能分支
git checkout -b feature/user-management

# 提交格式
git commit -m "feat: add user creation functionality"
git commit -m "fix: resolve authentication issue"
git commit -m "docs: update API documentation"
```

#### 2.2 代码审查
- 所有代码变更必须通过 Pull Request
- 至少需要一位同事审查代码
- 通过所有自动化测试

### 3. 测试规范

#### 3.1 后端测试
```bash
# 运行测试
cd backend
python -m pytest

# 运行特定测试
python -m pytest tests/api/routes/test_users.py

# 测试覆盖率
python -m pytest --cov=app
```

#### 3.2 前端测试
```bash
# 单元测试
npm run test

# 端到端测试
npm run test:e2e

# 类型检查
npm run type-check
```

### 4. 部署规范

#### 4.1 环境区分
- **local**: 本地开发环境
- **staging**: 测试环境
- **production**: 生产环境

#### 4.2 部署流程
```bash
# 构建镜像
./scripts/build.sh

# 部署到staging环境
ENVIRONMENT=staging ./scripts/deploy.sh

# 部署到生产环境
ENVIRONMENT=production ./scripts/deploy.sh
```

## 安全规范

### 1. 认证和授权
- 使用 JWT Token 进行认证
- Token 存储在 localStorage 中
- API 调用自动携带 Authorization 头
- 实现角色基础的权限控制（普通用户、超级用户）

### 2. 数据验证
- 后端使用 Pydantic 进行数据验证
- 前端使用 React Hook Form + Zod 进行表单验证
- 敏感数据传输使用 HTTPS

### 3. 错误处理
- 不在错误信息中暴露敏感信息
- 统一的错误响应格式
- 客户端统一错误处理机制

## 性能优化规范

### 1. 后端优化
- 数据库查询优化，避免 N+1 问题
- 使用数据库索引
- 实现分页查询
- 使用连接池管理数据库连接

### 2. 前端优化
- 使用 React.memo 避免不必要的重渲染
- 路由级别的代码分割
- 图片懒加载和压缩
- TanStack Query 缓存策略

## 监控和日志规范

### 1. 错误监控
- 集成 Sentry 进行错误监控
- 生产环境启用错误追踪
- 关键操作记录审计日志

### 2. 性能监控
- 数据库查询性能监控
- API 响应时间监控
- 前端页面性能监控

## 文档维护规范

### 1. API 文档
- 使用 FastAPI 自动生成 OpenAPI 文档
- 路由函数必须提供详细的文档字符串
- 定期更新 API 变更文档

### 2. 代码文档
- 复杂业务逻辑必须添加注释
- 公共函数和类必须提供文档字符串
- 定期更新 README 和部署文档

---

以上规范是基于当前项目架构制定的开发标准，请在二次开发过程中严格遵守。如有疑问或需要补充，请及时与团队沟通。
